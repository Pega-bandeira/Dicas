# **Desafio de PersistÃªncia**

## ğŸ§¹ **Limpando conteÃºdo inseguro existente**

Para este aplicativo simples, nossa **view** agora estÃ¡ protegida contra **XSS armazenado**, pois o template de post escapa corretamente a entrada do usuÃ¡rio.

No entanto, dependendo de como a entrada do usuÃ¡rio armazenada Ã© usada, pode ser necessÃ¡rio realizar **etapas adicionais de sanitizaÃ§Ã£o**.

### ğŸ”¹ CenÃ¡rio hipotÃ©tico

Imagine que o Rails esteja sendo usado apenas como **backend**, e um **front-end diferente** (que nÃ£o faz escape automÃ¡tico) esteja consumindo os dados.
Nesse caso, **pode ser necessÃ¡rio escapar a entrada do usuÃ¡rio antes de salvar no banco de dados**.

ğŸ“Œ Se essa proteÃ§Ã£o for **recÃ©m-implementada em um sistema jÃ¡ em produÃ§Ã£o**, tambÃ©m seria necessÃ¡rio **sanitizar os dados existentes no banco.**

---

## ğŸ› ï¸ **Atualizando a aplicaÃ§Ã£o Rails**

Vamos modificar a aplicaÃ§Ã£o Rails para refletir essa nova arquitetura, **sanitizando os posts diretamente antes de salvÃ¡-los no banco de dados.**

---

### 1ï¸âƒ£ **Abrindo o console Rails**

Digite no terminal:

```
rails c
```

Depois, liste os posts atuais:

```ruby
Post.all
```

ğŸ“Œ VocÃª verÃ¡ que o conteÃºdo dos posts foi salvo **literalmente**, incluindo **tags HTML** e atÃ© mesmo `<script>`.

---

### 2ï¸âƒ£ **Sanitizando posts jÃ¡ existentes**

Podemos rodar um **script Ãºnico de migraÃ§Ã£o**, usando o mÃ©todo Ruby `CGI::escapeHTML`, como no exemplo:

```ruby
escaped_text = CGI::escapeHTML(post.text)
```

---

### 3ï¸âƒ£ **Executando o script para atualizar os dados existentes**

No console Rails, execute:

```ruby
Post.all.each do |p|
  escaped_name = CGI::escapeHTML(p.name)
  escaped_text = CGI::escapeHTML(p.text)
  p.update_attributes(
    :name => escaped_name,
    :text => escaped_text
  )
end
```

âœ… Agora, **todos os posts terÃ£o seus conteÃºdos sanitizados**, com caracteres especiais convertidos para entidades HTML seguras.

---

## ğŸ”œ **PrÃ³ximos Passos**

* Abra um post que **antes incluÃ­a tags HTML**.
* Note que agora **vemos os caracteres escapados duas vezes**, como:

```
&lt;script&gt;  â†’  em vez de  <script>
```

---

### ğŸ”¹ O que fazer?

* Podemos **re-adicionar `.html_safe`** aos campos exibidos no template, **desde que tenhamos certeza absoluta** de que **todo o input do usuÃ¡rio jÃ¡ foi devidamente sanitizado** antes de ser salvo.

* No cenÃ¡rio em que usamos **apenas Rails com ERB templates**, **nÃ£o Ã© necessÃ¡rio escapar manualmente antes de salvar**, pois o Rails **jÃ¡ faz o escape automaticamente na renderizaÃ§Ã£o**.

âœ… **Melhor prÃ¡tica no Rails:**
ğŸ‘‰ Confiar no escape automÃ¡tico das views (ERB), evitando cÃ³digo extra e **reduzindo o risco de esquecer de sanitizar ou de usar `.html_safe` no lugar errado**.
