# ğŸ›¡ï¸ **XSS Armazenado vs. CSP (Content Security Policy)**

## ğŸ“Œ IntroduÃ§Ã£o

Este laboratÃ³rio demonstra uma vulnerabilidade de **Cross-Site Scripting (XSS) armazenado**.
Mostraremos como **enviar conteÃºdo malicioso para o servidor**, que pode afetar outros usuÃ¡rios, e como o uso de **Content Security Policy (CSP)** pode ajudar a prevenir esse ataque.

ğŸ“Œ Um dos exemplos mais famosos de XSS armazenado foi o **verme Samy**, que infectou mais de **1 milhÃ£o de usuÃ¡rios do MySpace em menos de 20 horas**.
Casos recentes incluem vulnerabilidades no **WordPress**, no **aplicativo iPhone do Trello** e na rede social russa **VK**.

---

## ğŸ§ª Passo 1 â€“ Upload de ConteÃºdo Malicioso

### ğŸ”¹ Testando upload normal

* FaÃ§a upload de **uma imagem** para o app.
* Verifique se o arquivo Ã© exibido corretamente.

### ğŸ”¹ Testando upload malicioso

1. Crie um arquivo **HTML local** contendo cÃ³digo JavaScript, por exemplo:

```html
<script>alert(1)</script>
```

2. FaÃ§a **upload desse arquivo com extensÃ£o `.html`**.

3. Abra o arquivo no navegador â†’ O **JavaScript serÃ¡ executado**, demonstrando a vulnerabilidade.

ğŸ“Œ Isso mostra que **qualquer usuÃ¡rio que acessar o link** acabarÃ¡ **executando cÃ³digo malicioso** automaticamente.

---

## ğŸ›¡ï¸ Passo 2 â€“ Adicionando Content Security Policy (CSP)

Em vez de corrigir todos os problemas de upload neste laboratÃ³rio, vamos **bloquear a execuÃ§Ã£o de cÃ³digo inline** usando **CSP headers**.

O pacote **node-csp** jÃ¡ estÃ¡ instalado no app.

### âœ… Como implementar CSP no app.js

1ï¸âƒ£ **Importe o pacote no inÃ­cio do arquivo:**

```js
const csp = require('node-csp')
```

2ï¸âƒ£ **Defina as opÃ§Ãµes de CSP para permitir scripts apenas do servidor:**

```js
const cspOptions = {
  directives: {
    defaultSrc: ['self'],
    scriptSrc: ['self']
  }
}
```

3ï¸âƒ£ **Na rota `uploads/:file`, adicione antes de ler o arquivo:**

```js
csp.add(req, res, cspOptions)
```

4ï¸âƒ£ Salve o arquivo e reinicie o app:

```
boot
```

---

## ğŸ” Passo 3 â€“ Verificando a ProteÃ§Ã£o

ApÃ³s configurar o CSP:

* Abra novamente a **pÃ¡gina HTML maliciosa enviada**.
* O `<script>` ainda estarÃ¡ no cÃ³digo-fonte, **mas nÃ£o serÃ¡ executado**.

Abra o **console do navegador** e veja o aviso:

```
Refused to execute inline script because it violates the following Content Security Policy directive: "script-src 'self'".
```

âœ… O **CSP bloqueou a execuÃ§Ã£o de cÃ³digo inline**. **XSS prevenido!**

---

## ğŸ“– Resumo

âœ” **Antes:** Upload de arquivo HTML com `<script>` â†’ Executava JS no navegador.
âœ” **Depois (com CSP):** O cÃ³digo Ã© exibido como texto, mas **nÃ£o Ã© executado**.

---

### ğŸ”’ Boas prÃ¡ticas adicionais (fora do escopo deste lab)

âœ… Restringir **tipos de arquivos permitidos** (somente imagens).
âœ… Definir **limites de tamanho** e validaÃ§Ãµes para uploads.
âœ… Fazer **sanitizaÃ§Ã£o do conteÃºdo** antes de armazenar.
âœ… Usar **verificaÃ§Ã£o de MIME type** para evitar uploads falsos.
