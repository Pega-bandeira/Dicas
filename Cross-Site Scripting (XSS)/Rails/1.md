
# ğŸ”¥ **XSS Refletido e FormataÃ§Ã£o de Entrada**

## ğŸ“Œ IntroduÃ§Ã£o

**Cross-site scripting (XSS)** Ã© um tipo de ataque onde um usuÃ¡rio pode injetar cÃ³digo malicioso em uma pÃ¡gina, que pode ser executado por outro usuÃ¡rio desavisado.

Mesmo sendo uma vulnerabilidade antiga, o XSS ainda Ã© comum e fÃ¡cil de passar despercebido. Por exemplo, a equipe da **Veracode Security Labs** relatou um caso de XSS em um pacote Python popular, e atÃ© **o login do Facebook Mobile** foi vulnerÃ¡vel a XSS atÃ© o final de 2017.

Existem duas formas principais de XSS:

* **Refletido (nÃ£o persistente)** â€“ O atacante envia uma requisiÃ§Ã£o que imediatamente executa cÃ³digo malicioso.
* **Armazenado (persistente)** â€“ O conteÃºdo malicioso Ã© salvo no servidor e entregue a outros usuÃ¡rios.

Neste laboratÃ³rio, um **aplicativo Rails** reflete de forma insegura a entrada do usuÃ¡rio em mensagens de erro, permitindo a injeÃ§Ã£o de cÃ³digo malicioso.

---

## ğŸ§ª Testando um XSS Refletido

1. Submeta um post com **um Nome e Texto muito curtos**.
   ğŸ”¹ O app exibirÃ¡ mensagens de erro incluindo os valores inseridos.

2. No campo **Texto**, insira:

```html
<script>alert(1)</script>
```

ğŸ“Œ **Resultado esperado:**
Um alerta aparecerÃ¡, confirmando a execuÃ§Ã£o do cÃ³digo JavaScript.

3. Tente tambÃ©m inserir HTML, como:

```html
<h1>OlÃ¡!</h1>
```

Ou atÃ© mesmo alterar o fundo da pÃ¡gina:

```html
<body style="background:red"></body>
```

âš ï¸ Como a execuÃ§Ã£o vem de um **POST**, o atacante **nÃ£o pode simplesmente enviar um link para outro usuÃ¡rio**.
Esse tipo de ataque poderia ser combinado com **CSRF/XSRF (Cross-Site Request Forgery)**.

---

## ğŸ”’ CabeÃ§alho X-XSS-Protection

No arquivo **config/environments/development.rb**, hÃ¡ a linha:

```ruby
config.action_dispatch.default_headers = {'X-XSS-Protection' => '0'}
```

ğŸ“Œ Isso **desativa a proteÃ§Ã£o de XSS** em navegadores antigos.

### âœ… CorreÃ§Ã£o

â¡ï¸ Remova essa linha, salve o arquivo e reinicie o app:

```
boot
```

Agora, alguns navegadores podem exibir uma mensagem informando que conteÃºdo suspeito foi bloqueado.

---

## ğŸ›¡ï¸ Escapando Entrada de UsuÃ¡rio

No arquivo **/app/views/posts/new\.html.erb**, encontramos:

```erb
<li><%= msg.html_safe %></li>
```

ğŸ“Œ O uso de `.html_safe` **desativa a proteÃ§Ã£o de escape padrÃ£o do Rails**, permitindo execuÃ§Ã£o de HTML/JS inserido pelo usuÃ¡rio.

### âœ… CorreÃ§Ã£o

Troque por:

```erb
<li><%= msg %></li>
```

Agora, se vocÃª inserir `<script>alert(1)</script>`, verÃ¡ o texto **exibido como texto puro**, e nÃ£o como cÃ³digo executÃ¡vel:

```
&lt;script&gt;alert(1)&lt;/script&gt;
```

---

## ğŸ¨ Mantendo a FormataÃ§Ã£o HTML

O aplicativo ainda utiliza tags `<em>` para formatar mensagens de erro.
O arquivo **/app/models/post.rb** contÃ©m algo como:

```ruby
length: { minimum: 50, message: "<em>%{value}</em> is too short (minimum is 50 characters)" }
```

ğŸ“Œ Se quisermos manter as tags `<em>` mas **escapar a entrada do usuÃ¡rio**, podemos modificar assim:

```ruby
length: {
  minimum: 50,
  message: -> (object, data) do
    html_err = "<em>".html_safe
    html_err << "#{data[:value]}"
    html_err << "</em> is too short (minimum is 50 characters)".html_safe
  end,
}
```

Depois disso, podemos **adicionar novamente `.html_safe`** ao `msg` no template:

```erb
<li><%= msg.html_safe %></li>
```

âœ… Assim, **o texto do usuÃ¡rio serÃ¡ escapado**, mas as tags `<em>` fornecidas pelo desenvolvedor serÃ£o renderizadas corretamente.

---

## âœ… ConclusÃ£o

* âœ”ï¸ Identificamos e exploramos **XSS refletido** em mensagens de erro.
* âœ”ï¸ Removemos o cabeÃ§alho inseguro `X-XSS-Protection`.
* âœ”ï¸ Corrigimos o template para **escapar entradas de usuÃ¡rio**.
* âœ”ï¸ Mantivemos formataÃ§Ã£o segura com tags HTML controladas pelo desenvolvedor.

---

âš¡ **PrÃ³ximos Passos:**
â¡ï¸ Aprender sobre **XSS persistente**, onde arquivos ou campos maliciosos sÃ£o **armazenados no servidor** e entregues a outros usuÃ¡rios.
